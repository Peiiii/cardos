# Cardos 架构优化设计文档

## 一、项目概述

Cardos 是一个基于 React + TypeScript 的现代化 Web 应用，采用插件化架构设计，支持聊天、卡片管理等功能。本文档主要针对系统架构的两个核心部分提出优化方案：状态管理和插件系统。

## 二、状态管理优化

### 1. 现状分析

当前系统使用 Zustand 作为状态管理库，存在以下问题：
- 多个独立的 store（navigation、sidebar、theme、chat 等）
- 状态分散，缺乏统一管理
- 状态复用和共享机制不完善
- 部分状态持久化实现不完整

### 2. 优化方案：状态分层 + 切片模式

#### 2.1 架构设计

```
状态架构
├── 核心状态层 (Core State)
│   ├── 应用状态
│   ├── 错误处理
│   └── 全局配置
├── 领域状态层 (Domain State)
│   ├── 聊天模块状态
│   ├── 卡片模块状态
│   └── 设置模块状态
└── UI状态层 (UI State)
    ├── 主题状态
    ├── 布局状态
    └── 导航状态
```

#### 2.2 实现特点

- **状态分层**：将状态划分为核心、领域和UI三层
- **状态切片**：使用切片模式组织各功能模块状态
- **选择器模式**：使用选择器访问和派生状态
- **持久化策略**：细粒度控制状态持久化

#### 2.3 主要优势

- 状态层次清晰，便于维护
- 细粒度更新提升性能
- 模块化设计提高可扩展性
- 类型安全，开发体验佳

## 三、插件系统优化

### 1. 现状分析

当前插件系统存在以下问题：
- 基础的插件注册/注销机制
- 缺乏完整的生命周期管理
- 缺少插件间通信机制
- 依赖管理不完善

### 2. 优化方案：事件驱动 + 依赖注入混合模式

#### 2.1 架构设计

```
插件系统架构
├── 插件核心 (Plugin Core)
│   ├── 插件管理器 (Plugin Manager)
│   ├── 事件总线 (Event Bus)
│   └── 依赖解析器 (Dependency Resolver)
├── 插件生命周期 (Plugin Lifecycle)
│   ├── 安装 (install)
│   ├── 激活 (activate)
│   ├── 停用 (deactivate)
│   └── 卸载 (uninstall)
└── 扩展点系统 (Extension Points)
    ├── 视图扩展
    ├── 命令扩展
    └── 服务扩展
```

#### 2.2 实现特点

- **事件总线**：插件间通过事件机制通信
- **服务注册**：插件可注册和发现服务
- **完整生命周期**：支持插件的安装、激活、停用和卸载
- **依赖管理**：自动检查和解析插件依赖

#### 2.3 主要优势

- 松耦合设计，降低模块间依赖
- 扩展性强，支持动态加载卸载
- 可测试性好，便于单元测试
- 维护性好，架构清晰

> **注意**: 插件系统的详细设计已经移至独立文档 [扩展系统架构](./extension-system.md)，请参考该文档获取完整的扩展系统设计细节。

## 四、实施路线图

### 1. 第一阶段：状态管理优化（2-3周）
- 创建新的状态层次结构
- 重构现有状态为切片模式
- 实现状态持久化和选择器优化

### 2. 第二阶段：插件系统优化（3-4周）
- 实现事件总线和插件上下文
- 设计插件生命周期接口
- 改进依赖管理和服务注册

### 3. 第三阶段：集成与测试（2周）
- 状态系统与插件系统集成
- 编写测试和进行性能优化
- 文档编写和团队培训

## 五、预期效益

### 1. 技术效益
- 代码组织更清晰，维护成本降低
- 系统性能提升，用户体验改善
- 开发效率提高，扩展更容易

### 2. 业务效益
- 功能迭代速度提升
- 系统稳定性增强
- 用户体验一致性提高

## 六、风险与对策

### 1. 主要风险
- 迁移过程中的兼容性问题
- 学习曲线和团队适应
- 重构过程中的bug风险

### 2. 应对策略
- 分阶段实施，保持向后兼容
- 提供详细文档和培训
- 完善测试覆盖，确保质量

## 七、核心接口定义

### 状态管理接口

```typescript
// 1. 核心状态接口
interface CoreState {
  appStatus: 'idle' | 'loading' | 'error';
  error: Error | null;
  setAppStatus: (status: 'idle' | 'loading' | 'error') => void;
  setError: (error: Error | null) => void;
}

// 2. 状态切片创建接口
type StateCreator<T> = (set: SetState<T>, get: GetState<T>) => T;

// 3. 状态选择器接口
type Selector<T, U> = (state: T) => U;

// 4. 状态持久化配置接口
interface PersistOptions<T> {
  name: string;
  storage?: Storage;
  partialize?: (state: T) => Partial<T>;
  version?: number;
  migrate?: (state: any, version: number) => T | Promise<T>;
}
```

---

*注：本文档为架构设计概要，详细实现方案和代码示例请参考技术规范文档。* 